# [2021-2022学年第2学期](https://js-sigcc.vercel.app/#/lab/proj.final?id=_2021-2022学年第2学期)

# [**实 验 报 告**](https://js-sigcc.vercel.app/#/lab/proj.final?id=实-验-报-告)

![zucc](https://js-sigcc.vercel.app/zucc.png)

- 课程名称:跨平台脚本开发技术
- 实验项目:期末大作业
- 专业班级<u>计算1902、计算1902</u>
- 学生学号<u>31901060、31901061</u>
- 学生姓名<u>张亦骞、张泽峰</u>
- 实验指导教师:郭鸣

## [实验内容](https://js-sigcc.vercel.app/#/lab/proj.final?id=实验内容)

1. ~~翻译英文 每人5页.~~
2. （选做）完成一个介绍JS进展的技术报告,要求如下，附加分。
   - 内容范围
     - Javascript语言新技术动向
       - 如 async await, generator,webassembly, web socket,Service Worker, Reflect API 等
     - Javascript框架 vue, cyclejs,infernojs, sveltejs,hyperapp... 介绍框架原理,使用案例.
     - Javascript 某个技术实现 Vdom,GraphQL
     - 技术报告范例参考[500 Lines or Less](http://www.aosabook.org/en/index.html)
   - 提交形式
     - 提交 code + markdown文档
   - 技术报告讲座 (可选,加分)
     - 预计 20分钟左右,下下周开始
     - 制作 ppt (markdown)
   - 自我评估 5为最高
     - 原创性 (1-5)
     - 技术难度 (1-5)
     - 工作量 (1-5)
3. 大项目,分组完成,评分方式，以下为起始评分
   - 及格 在现有的项目代码
     - 现有代码修改与改进
     - 客户端有服务器API发起网络调用
     - 有简单的服务器处理逻辑
     - 能解释服务器REST API接口
     - 能展示 网络请求的 Request Response 数据
   - 中 采用前端框架,实现应用跨平台的适配，Desktop, Tablet, Mobile
     - 对现有功能有较多改进
   - 优秀/良 完成自定义项目.
     - 使用比较有特点JavaScript框架
       - solidjs/hyper/elm
     - 采用比较新颖的技术 例如FRP PWA Service Worker等
       - 函数式编程
       - 响应式编程
     - 项目有创新性与技术难度
4. 现有改进方式建议列表
   - 开发技术
     - UI 响应式设计
       - 采用 BootStrap, Material Design等前端框架
       - 支持 Desktop, Tablet, Mobile
     - 服务端 NodeJs框架
       - Express、Koa等实现服务端
     - WebSocket socket.io等实时交互技术
     - Web Assembly技术
5. 项目信息参考
   - 实际公司项目
     - JavaScript程序性能优化
     - GraphQL 项目
     - UI设计器
   - https://demo.realworld.io/#/
     - 前后端分离
   - 平台游戏 or 2048
     - 添加用户登录
       - 用户登录id 会话保存
       - 用户头像保存
     - 管理员后台
       - CRUD操作
     - 用户积分排行
       - 积分排行存储到本地
       - 积分排行存储到服务器
     - 实现游戏手机平台，平板的支持
     - 在线关卡编辑器
     - 5 * 5 2048
     - Time travel 编译器compiler/debugger
       - Cyclejs Time traveler
   - 图形化 FSM 编译器
     - http://jsflap.com/
     - http://bgrawi.com/Fourier-Visualizations/
     - http://www.jflap.org/
     - http://www.cs.sjsu.edu/faculty/pollett/154.1.11s/
     - http://hackingoff.com/compilers
     - https://github.com/jahan-addison/posiy
   - JS语言创新 在js 中实现其他语言的语法特性
     - https://github.com/slurmulon/flap
     - https://github.com/sanctuary-js/sanctuary
     - http://www.sweetjs.org/
   - 健康/中医/书法/太极/汉服/传统文化方面项目
     - [大家中医](http://www.dajiazhongyi.com/)
     - 中医资料学习
     - 传统养生 八段锦 练习 （https://gotokeep.com/）类似的中医锻炼软件
   - IT技术学习平台
     - https://github.com/rusthon/Rusthon
     - webpackbin.com
     - https://hourofpython.trinket.io/ke3-shi4-hua4-python-jian3-jie4#/huan1-ying2/bian1-cheng2-yi1-xiao3-shi2
   - Jupyter in browser 无服务端的jupyter?
     - https://try.jupyter.org/
     - https://github.com/jvilk/BrowserFS
     - http://slides.com/bahmutov/browser-is-the-new-server-nodefest
     - https://github.com/kripken/emscripten
     - http://cyrille.rossant.net/numpy-browser-llvm/
     - http://www.rfk.id.au/blog/entry/pypy-js-first-steps/?utm_source=tuicool&utm_medium=referral
   - 可视化项目
     - 服务端数据存储, 网页端显示数据
     - echarts NVD3.js
     - superset https://github.com/airbnb/superset
     - https://vega.github.io/voyager2/
     - [https://ipywidgets.readthedocs.io/en/latest/examples/Widget%20Basics.html](https://ipywidgets.readthedocs.io/en/latest/examples/Widget Basics.html)
   - 参考 https://electron.atom.io/
6. git 管理技术文档,和项目代码,可以使用 github desktop
   - 验收大作业的时候查看git log
   - npm i -g git-stats
   - https://github.com/tomgi/git_stats/graphs/contributors
7. 代码风格 standard https://standardjs.com/readme-zhcn.html
8. 项目分工表格

- 1人项目权重为1.0
- 2人项目权重和为 1.9

|  姓名  |   学号   |   班级   |                       任务                       | 权重 |
| :----: | :------: | :------: | :----------------------------------------------: | ---- |
| 张亦骞 | 31901060 | 计算1902 |    功能设计，游戏实现，服务器搭建，5*5模式，     | 0.95 |
| 张泽峰 | 31901061 | 计算1902 | 功能设计，首页，我的界面，登录模块，排行榜模块， | 0.95 |

1. 项目自我评估表（0-5）

| 函数式编程 | xhr fetch api | FRP  |      session Storage      | 响应式编程 | Other |
| :--------: | :-----------: | :--: | :-----------------------: | :--------: | :---: |
|     5      |               |      |                           |            |       |
|  纯函数√   |   Promise√    |      | 微信小程序的localStorage√ |            |       |

1. 项目自评等级:(1-5)

   等级：

   

2. 项目说明

   1. 使用的技术

   |      前端      |  后端   |
   | :------------: | :-----: |
   |   微信小程序   | nodejs  |
   | js（业务逻辑） | express |
   |       /        |   js    |
   |       /        |  mysql  |

   

   2. 项目是基于现有的2048代码

      参考的代码来自：https://github.com/windlany/wechat-weapp-2048

      *注：微信小程序（以下简称客户端），nodejs服务器（以下简称服务器），mysql数据库（以下简称数据库）*

   - **改进2048游戏界面。开发当前得分、最高分、增加重新开始游戏功能模块。**

     ​		游戏厅界面分为上面和下面两块区域。

     ​		上面区域从左至右分别是：2048游戏名标题、重新开始按钮、当前得分、最高分。

     ​		点击重新开始按钮，用户可以在【一局进行中的游戏】进行重新开始一局游戏的操作。代码如下：

     ```js
     //一局游戏结束点击重新开始按钮
       restart() {
         this.setData({
           isFinished: false
         })
     
         //开始游戏
         this.start();
       },
     ```

     ​		当前得分显示用户在当前操作后所获得的分数，分数计算方法是在棋盘中找到最大数字的格子，取该最大数字为当前得分。代码如下：

     ```js
     //取当前这一刻的最好成绩（即棋盘中存在的最大数字）
         var max = 0; //最大值
         for (var i = 0; i < this.data.size; i++) {
           for (var j = 0; j < this.data.size; j++) {
             if (data[i][j] !== "" && data[i][j] > max) { //当前格子不为空且数字大于max
               max = data[i][j]; //找到当前棋盘中最大的，设置为当前成绩
             }
           }
         }
     ```

     ​		当用户在游戏入口页（即首页）点击开始游戏按钮进入到游戏厅时，客户端向服务器发送网络请求，获取数据库中user表的当前用户的最高普通模式的成绩，把它set到game.js页面。代码详见【（1）游戏厅的网络请求部分】。

     ------------------------------------------------------------------------------------------------------------------------------------------------------

     ​		下面区域为2048棋盘。棋盘绘制与生成主要涉及到game.js、manager.js、grid.js三个js文件。game.js为主入口文件。在游戏厅当前页面的onReady生命周期中，首先调用start()开始游戏函数，该函数的过程如下：

     1、创建一个棋盘管理类，并setData到game.js。

     （1）调用Manager的构造函数，把棋盘大小4传给Manager.js。设置棋盘大小，初始化填充的格子个数为2（第一个棋盘中会出现2个有数字的格子）。

     ```js
     function Manager(size) { 
       this.size = size;//棋盘的大小。从2048.js传入
       this.fillNum = 2;//填充的个数。初始填充2个格子
       this.init();//初始化
     }
     ```

     （2）调用Grid的构造函数，把棋盘大小4传给Grid.js。生成一个空的二维数组，返回给Manager管理类的checkerboard对象。

     ```js
     var grid = []; //二维数组
         for (var i = 0; i < this.size; i++) {
           grid[i] = []; //每一行都是一个空数组
           for (var j = 0; j < this.size; j++) {
             grid[i].push(""); //每一行的每一个格子都是空的
           }
         }
         return grid;
     ```

     （3）使用`this.bproto = this.checkerboard.__proto__;`获取checkerboard在Grid中的父对象，以使用Grid中调用的方法和属性。

     （4）调用getRandomCell函数随机填充格子。

     ​		首先调用checkerboard父对象的isCellEmpty方法判断棋盘是否有可用的空格子，有的话就添加数字。数字的生成方法是：

     ```js
     var value = Math.random() < 0.9 ? 2 : 4;//生成10%的4，90%的2
     ```

     ​		接着在可填充的格子中【调用checkerboard的selectCell方法】随机选择一个格子作为要填充的格子。可填充的格子是通过遍历棋盘这个二维数组，找到值是""的格子，把该格子的x和y坐标push到一个数组中，返回回去。

     ```js
     //从可使用的空格子中随机选一个
       selectCell() {
         var emptyCells = this.findEmptyCell(); //所有空格子
         if (emptyCells.length) { //若存在空格子
           return emptyCells[Math.floor(Math.random() * emptyCells.length)]; //随机返回这些空格子中的一个
           //Math.random()生成[0,1)的随机数
           //Math.floor对生成的随机数向下取整
           //如emptyCells[2]表示第三个可用的空格子，存有该格子的x和y坐标值
         }
       },
     ```

     ​		然后把生成的随机数赋给刚才随机选择的格子。

     ​		最后更新棋盘数据，把上面得到的格子的x坐标和y坐标传给checkerboard的grid。

     （5）把接下来每一次随机生成的格子的个数变为1。即把manager对象的fillNum属性赋值为1。

     2、把棋盘管理类manager的父类型赋值给game.js中manager对象。

     ```js
     this.data.manager.__proto__ = manager.__proto__; //让this.data中的manager对象能使用manager对象的父类型的方法和属性
     ```

     3、设置hidden、isFinished、score等变量的初始化，并把checkerboard的grid棋盘赋值给game.js的grids，这样就能在页面中显示使用棋盘。

     ----------------------------------------------------------------------------------------------------------------------------

     ​		用户在棋盘上的滑动格子操作具体如下：

     1、通过在game.wxml绑定touchStart、touchMove和touchEnd函数监听触摸的操作。

     （1）初始化touchStartX、touchStartY、touchEndX、touchEndY四个变量为0

     （2）滑动格子，分别记录开始滑动时的x、y坐标，最后移动时的x、y坐标，在滑动格子的操作结束后，分别计算x、y轴上滑动的距离的绝对值。然后判断棋盘中是否有可以滑动合并的格子，有就表示未结束，没有就表示这局游戏结束了。

     （2-1）游戏结束，就保存成绩等数据到数据库。

     （2-2）游戏未结束，判断是否滑动【以上下或左右滑动距离大于10px为判断标准，即`if (Math.max(absdisX, absdisY) > 10) {...}`】，有滑动就让棋盘中的格子按指定滑动方向滑动，并合并能合并的格子。然后更新棋盘。

     2、四个方向移动格子的实现

     （1）将滑动方向标记为   0:上, 1:右, 2:下, 3:左

     （2）

     

     

   - **开发5*5游戏模式**

     

     

   - **开发服务器端**

     ​		使用express+nodejs+mysql，通过express框架创建服务器，使用mysql数据库，将数据存储在数据库中，开发过程中数据库查看通过Navicat查看。
     
     **（1）游戏厅的网络请求部分**
     
     ​		当用户在游戏入口页（即首页）点击开始游戏按钮进入到游戏厅时，客户端向服务器发送网络请求，获取数据库中user表的当前用户的最高普通模式的成绩，把它set到game.js页面。
     
     ​		发送网络请求的代码如下：
     
     ```js
     //从数据库获取最高分
       getMaxScore() {
         wx.request({
           method: 'GET',
           url: 'http://127.0.0.1:3000/game/getMax/' + app.globalData.user_id, //当前登录用户的id
           //data:{},
           header: {
             'content-type': 'application/json'
           },
           success: (res) => {
             console.log(res.data)
             var tmp = -1
             if (res.data.msg.max_grade === null) { // 若数据库中还没有记录过成绩，就把tmp赋值0
               tmp = 0
             } else { // 否则赋值数据库中的成绩
               tmp = res.data.msg.max_grade
             }
     
             this.setData({
               maxScore: tmp
             })
           },
           fail: () => {
             console.log("普通模式最高成绩获取失败！")
           }
         })
       }
     ```
     
     ​		服务器中的接收客户端网络请求的代码如下：
     
     ```js
     //获取最高成绩
     module.exports.getMax = (req, res) => {
       console.log(req.params) //获得请求体
       let param = [req.params.id] //sql语句参数进行处理
       var sql = "select max_grade from user where id=?;"; //sql语句
       pool.query(sql, param, (error, result) => { //第一个参数sql语句，第二个参数是sql语句的参数
         if (error) { //有错误
           res.json({
             status: "400",
             data: '普通模式获取最高成绩失败',
             msg: error
           })
         } else { //成功
           console.log(result[0])
           res.json({
             status: "200",
             data: '普通模式获取最高成绩成功',
             msg: result[0]
           })
         }
       });
     }
     ```
     
     （2）
     
     ​		
     
     
     
   - 开发

     
     
   - 开发

     

3. 解决技术要点说明

   - 解决 nodejs服务器与微信小程序的数据交互 问题， 关键代码与步骤如下

     

   - 解决 xxx 问题， 关键代码与步骤如下

     

4. 心得体会（结合自己情况具体说明）

   - 大项目开发过程心得
     - 遇到哪些困难，经历哪里过程，有哪些收获
     - 
   - 本课程建议
     - 课程难度方面，进度方面，课程内容，授课方式等，给出你的意见
     - 
